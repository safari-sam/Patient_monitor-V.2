#!/bin/bash
# ============================================================================
# Smart Patient Room Monitor - Pre-commit Hook
# ============================================================================
# This hook runs before each commit to ensure code quality.
# 
# Installation:
#   ./setup-hooks.sh
# OR manually:
#   cp hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
# ============================================================================

set -e  # Exit on any error

echo "üîç Running pre-commit checks..."
echo "================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# ----------------------------------------------------------------------------
# 1. Rust Format Check
# ----------------------------------------------------------------------------
echo -e "\n${YELLOW}[1/4] Checking Rust formatting...${NC}"
cd monitor/backend
if cargo fmt --all -- --check > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì Formatting OK${NC}"
else
    echo -e "${RED}‚úó Formatting issues found!${NC}"
    echo "  Run 'cd monitor/backend && cargo fmt' to fix formatting."
    FAILED=1
fi

# ----------------------------------------------------------------------------
# 2. Rust Linting (Clippy)
# ----------------------------------------------------------------------------
echo -e "\n${YELLOW}[2/4] Running Clippy linter...${NC}"
if cargo clippy --all-targets --all-features -- -D warnings > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì Clippy OK${NC}"
else
    echo -e "${RED}‚úó Clippy found issues!${NC}"
    echo "  Run 'cd monitor/backend && cargo clippy' to see details."
    FAILED=1
fi

# ----------------------------------------------------------------------------
# 3. Rust Tests
# ----------------------------------------------------------------------------
echo -e "\n${YELLOW}[3/4] Running Rust tests...${NC}"
if cargo test > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì Tests passed${NC}"
else
    echo -e "${RED}‚úó Tests failed!${NC}"
    echo "  Run 'cd monitor/backend && cargo test' to see details."
    FAILED=1
fi
cd ../..

# ----------------------------------------------------------------------------
# 4. Check for secrets/credentials
# ----------------------------------------------------------------------------
echo -e "\n${YELLOW}[4/4] Checking for hardcoded secrets...${NC}"

# Patterns that might indicate REAL hardcoded secrets
# Excludes environment variable fallback patterns and development markers
PATTERNS=(
    "password\s*=\s*['\"][a-zA-Z0-9!@#$%^&*]{8,}['\"]"  # Real password-like strings
    "secret\s*=\s*['\"][a-zA-Z0-9]{16,}['\"]"          # Real secret keys (16+ chars)
    "api_key\s*=\s*['\"][a-zA-Z0-9]{20,}['\"]"         # Real API keys
    "PRIVATE_KEY.*BEGIN"                                # Private key blocks
)

SECRET_FOUND=0
for pattern in "${PATTERNS[@]}"; do
    # Search in staged files, excluding:
    # - .env.example (template files)
    # - Documentation files (SECURITY.md, README.md, CODESPACES)
    # - CI/CD files (ci.yml, workflows)
    # - Files with environment variable patterns (${VAR:-default})
    # - Test/development values (postgres, development_only, test_secret)
    if git diff --cached | grep -E "$pattern" | grep -v ".env.example" | grep -v "SECURITY.md" | grep -v "README.md" | grep -v "CODESPACES" | grep -v "ci.yml" | grep -v "workflows" | grep -v "\${.*:-" | grep -v "development_only" | grep -v "postgres" | grep -v "test_secret" > /dev/null 2>&1; then
        SECRET_FOUND=1
    fi
done

if [ $SECRET_FOUND -eq 0 ]; then
    echo -e "${GREEN}‚úì No hardcoded secrets detected${NC}"
else
    echo -e "${RED}‚úó Possible hardcoded secrets found!${NC}"
    echo "  Please use environment variables instead."
    FAILED=1
fi

# ----------------------------------------------------------------------------
# Final Result
# ----------------------------------------------------------------------------
echo ""
echo "================================"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    exit 0
else
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo "Please fix the issues above before committing."
    echo ""
    echo "To skip these checks (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
fi
